"""配置生成模块 - 生成 YOLO data.yaml"""

from pathlib import Path
from typing import Optional

from .reader import ClassConfig
from .formats import DatasetFormat, FORMAT_INFO


class YAMLConfigGenerator:
    """YOLO data.yaml 配置生成器"""

    def __init__(
        self,
        output_dir: str | Path,
        class_config: ClassConfig,
        format: DatasetFormat = DatasetFormat.YOLO,
        has_train: bool = True,
        has_val: bool = True,
        has_test: bool = True
    ):
        self.output_dir = Path(output_dir).resolve()
        self.class_config = class_config
        self.format = format
        self.has_train = has_train
        self.has_val = has_val
        self.has_test = has_test

    def _get_format_name(self) -> str:
        """获取格式名称"""
        format_info = FORMAT_INFO.get(self.format)
        return format_info.name if format_info else "Unknown"

    def generate(self, output_path: Optional[str | Path] = None) -> Path:
        """生成 data.yaml 文件"""
        if output_path is None:
            output_path = self.output_dir / "data.yaml"
        else:
            output_path = Path(output_path)

        format_name = self._get_format_name()

        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(f"# Dataset configuration for {format_name}\n")
            f.write(f"# Generated by DatasetMaster\n\n")
            f.write(f"path: {self.output_dir}\n")

            if self.has_train:
                f.write(f"train: images/train\n")
            if self.has_val:
                f.write(f"val: images/val\n")
            if self.has_test:
                f.write(f"test: images/test\n")

            f.write(f"\n")
            f.write(f"nc: {self.class_config.nc}\n")
            f.write(f"names: {self.class_config.names}\n")

        return output_path

    def generate_dict(self) -> dict:
        """生成配置字典（用于预览）"""
        config = {
            "path": str(self.output_dir),
        }

        if self.has_train:
            config["train"] = "images/train"
        if self.has_val:
            config["val"] = "images/val"
        if self.has_test:
            config["test"] = "images/test"

        config["nc"] = self.class_config.nc
        config["names"] = self.class_config.names

        return config
